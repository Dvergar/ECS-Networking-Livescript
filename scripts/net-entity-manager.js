// Generated by LiveScript 1.2.0
(function(){
  'use strict';
  var NetEntityManager, net, out$ = typeof exports != 'undefined' && exports || this;
  NetEntityManager = (function(superclass){
    var entities, syncComponents, templateIds, CREATE_ENTITY, CREATE_TEMPLATE_ENTITY, ADD_COMPONENT, REMOVE_COMPONENT, EVENT, prototype = extend$((import$(NetEntityManager, superclass).displayName = 'NetEntityManager', NetEntityManager), superclass).prototype, constructor = NetEntityManager;
    entities = {};
    syncComponents = {};
    prototype.templates = {};
    templateIds = numMessages;
    prototype.input = new dcodeIO.ByteBuffer;
    prototype.output = new dcodeIO.ByteBuffer;
    CREATE_ENTITY = 0;
    CREATE_TEMPLATE_ENTITY = 1;
    ADD_COMPONENT = 2;
    REMOVE_COMPONENT = 3;
    EVENT = 4;
    function NetEntityManager(){
      NetEntityManager.superclass.call(this);
      this.onData = this._onData;
      this.input.BE();
      this.output.BE();
    }
    prototype.createEntity = function(){
      var entity;
      entity = em.createEntity();
      this._sendCreateEntity(entity);
      console.log(this.output.toColumns());
      return entity;
    };
    prototype._sendCreateEntity = function(entity){
      var x$;
      entities[entity.id] = entity;
      x$ = this.output;
      x$.writeInt8(CREATE_ENTITY);
      x$.writeInt16(entity.id);
      return x$;
    };
    prototype.addComponent = function(entity, component){
      em.addComponent(entity, component);
      return this._sendAddComponent(entity.id, component);
    };
    prototype._sendAddComponent = function(entityId, component){
      var x$, compenc;
      console.log('_sendAddComponent');
      x$ = this.output;
      x$.writeInt8(ADD_COMPONENT);
      x$.writeInt16(entityId);
      x$.writeInt8(component.id);
      compenc = component.encode();
      x$.writeInt16(compenc.length);
      console.log('offset_' + x$.offset);
      x$.append(compenc);
      console.log('offset_' + x$.offset);
      console.log('length_' + x$.length);
      console.log(x$.toColumns());
      return x$;
    };
    prototype.removeComponent = function(entity, componentType){
      var x$;
      console.log('removeComponent');
      console.log(entity.get(componentType).sync);
      x$ = this.output;
      x$.writeInt8(REMOVE_COMPONENT);
      x$.writeInt16(entity.id);
      x$.writeInt8(componentType.id);
      return console.log('pasquoifaire');
    };
    prototype.create = function(entityFunction, triggerEvent){
      var entity, x$, i$, ref$, len$, component;
      if (triggerEvent === undefined) {
        triggerEvent = false;
      }
      entity = entityFunction();
      x$ = this.output;
      x$.writeInt8(CREATE_TEMPLATE_ENTITY);
      x$.writeInt8(entityFunction.id);
      x$.writeInt16(entity.id);
      x$.writeInt8(triggerEvent);
      for (i$ = 0, len$ = (ref$ = entity.components).length; i$ < len$; ++i$) {
        component = ref$[i$];
        if (component !== undefined) {
          this._sendAddComponent(entity.id, component);
          if (component.sync) {
            syncComponents[entity.id] = component;
          }
        }
      }
      return entity;
    };
    prototype.pump = function(){
      var x$, entityId, ref$, component, y$;
      x$ = this.output;
      if (x$.offset > 0) {
        this.send(
        x$.toArrayBuffer());
        x$.reset();
      }
      for (entityId in ref$ = syncComponents) {
        component = ref$[entityId];
        console.log('SYNC');
        this._sendAddComponent(entityId, component);
      }
      y$ = this.input;
      if (y$.offset > 0) {
        y$.flip();
        this.readMessage();
        y$.reset();
      }
      return y$;
    };
    prototype.registerTemplate = function(template){
      template.id = templateIds++;
      return this.templates[template.id] = template;
    };
    prototype.sendEvent = function(event){
      var x$, compenc;
      console.log('sendEvent');
      x$ = this.output;
      console.log('offset_' + x$.offset);
      x$.writeInt8(EVENT);
      x$.writeInt8(event.id);
      compenc = event.encode();
      x$.writeInt16(compenc.length);
      console.log('offsetbeforeevent_' + x$.offset);
      x$.append(compenc);
      console.log('offsetafterevent_' + x$.offset);
      console.log(x$.toColumns());
      return x$;
    };
    prototype.readMessage = function(){
      var x$, msgtype, entityId, entity, entityType, triggerEvent, _eventType, ref$, func, componentType, msglength, mark, component, eventType, event;
      console.log('readMessage');
      console.log(this.input.toColumns());
      x$ = this.input;
      while (x$.remaining() > 0) {
        msgtype = x$.readInt8();
        switch (msgtype) {
        case CREATE_ENTITY:
          console.log('CREATE_ENTITY');
          entityId = x$.readInt16();
          entity = em.createEntity();
          entities[entityId] = entity;
          console.log(x$.toColumns());
          break;
        case CREATE_TEMPLATE_ENTITY:
          console.log('CREATE_TEMPLATE_ENTITY');
          entityType = x$.readInt8();
          entityId = x$.readInt16();
          triggerEvent = x$.readInt8();
          entity = this.templates[entityType]();
          entities[entityId] = entity;
          if (triggerEvent === 1) {
            for (_eventType in ref$ = em.events[entityType]) {
              func = ref$[_eventType];
              func({
                entity: entity
              });
            }
          }
          console.log('offset_' + x$.offset);
          break;
        case ADD_COMPONENT:
          console.log('ADD_COMPONENT');
          entityId = x$.readInt16();
          componentType = x$.readInt8();
          msglength = x$.readInt16();
          mark = x$.offset;
          console.log('mark_' + mark);
          console.log('entityId_' + entityId);
          console.log('componentType_' + componentType);
          console.log('msglength_' + msglength);
          console.log('afteroffset_' + (mark + msglength));
          console.log(this.input.toColumns());
          component = messages[componentType].decode(x$);
          em.addComponent(entities[entityId], component);
          x$.offset = mark + msglength;
          break;
        case REMOVE_COMPONENT:
          console.log('REMOVE_COMPONENT');
          entityId = x$.readInt16();
          componentType = x$.readInt8();
          em.removeComponent(entities[entityId], messages[componentType]);
          break;
        case EVENT:
          console.log('EVENT');
          eventType = x$.readInt8();
          msglength = x$.readInt16();
          mark = x$.offset;
          event = messages[eventType].decode(x$);
          for (_eventType in ref$ = em.events[eventType]) {
            func = ref$[_eventType];
            console.log('throevent');
            func(event);
          }
          x$.offset = mark + msglength;
        }
      }
      x$.reset();
      return x$;
    };
    prototype._onData = function(data){
      return this.input.append(
      dcodeIO.ByteBuffer.wrap(
      data));
    };
    return NetEntityManager;
  }(Net));
  out$.net = net = new NetEntityManager;
  function extend$(sub, sup){
    function fun(){} fun.prototype = (sub.superclass = sup).prototype;
    (sub.prototype = new fun).constructor = sub;
    if (typeof sup.extended == 'function') sup.extended(sub);
    return sub;
  }
  function import$(obj, src){
    var own = {}.hasOwnProperty;
    for (var key in src) if (own.call(src, key)) obj[key] = src[key];
    return obj;
  }
}).call(this);
